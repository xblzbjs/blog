+++
title = "Go & Python｜深拷贝与浅拷贝"
date = "2021-03-24"
author = "xblzbjs"
categories = [
    "design-patterns",
]
tags = [
  "go",
  "python",
]
+++



## 背景：

在开发中，经常涉及到数据的传递。在数据传递使用过程中，可能会发生数据被修改的问题。为了防止数据被修改，就需要再传递一个副本，即使副本被修改，也不会影响原数据的使用。为了生成这个副本，就产生了拷贝。

## 概念：

Python拷贝会涉及到Python中**对象、可变类型、引用**3个概念，下面一一介绍

1. 对象：Python对象都拥有三个属性：身份、类型、值。

```python
>>> name = "xblzbjs"		# name对象，值为'xblzbjs'
>>> id(name)				# 身份
2016648094384
>>> type(name)				# 类型
<class 'str'>
```

2. 可变类型：在Python中，按更新对象的方式，可以将对象分为2大类：可变对象与不可变对象。

   - 可变对象： 列表(list)、字典(dict)、集合(set)。所谓可变指可变对象的值可变，身份是不变的。

     ```python
     >>> l1 = [1,2,3]
     >>> id(l1)
     2016648193280
     >>> l1 = [1,2]
     >>> id(l1)
     2016648214464
     >>> l1[0]=3
     >>> l1
     [3, 2]
     >>> id(l1)
     2016648214464
     ```

   - 不可变对象：数字、字符串(str)、元组(tuple)。不可变对象指对象的身份和值都不可变。新创建的对象被关联到原来的变量名，旧对象被丢弃，垃圾回收器会在适当的时机回收这些对象。

     ```python
     >>> num = 4
     >>> id(num)
     140710421604224
     >>> num = 5
     >>> id(num)
     140710421604256
     ```

3. 引用：在Python程序中，每个对象都会在内存中申请开辟一块空间来保存该对象，该对象在内存中所在位置的地址被称为引用。在开发程序时，所定义的变量名实际就对象的地址引用。引用实际就是内存中的一个数字地址编号，在使用对象时，只要知道这个对象的地址，就可以操作这个对象，但是因为这个数字地址不方便在开发时使用和记忆，所以使用变量名的形式来代替对象的数字地址。

   ​	

   ```shell
   >>> age = 22
   >>> id(age)
   140710421604800
   >>> id(22)
   140710421604800
   ```

## 深拷贝与浅拷贝的区别

```python
# 定义一个数组对象
>>> l1								
[1, 2, 'a', ['a', 'b']]
# 浅拷贝
>>> l2 = copy.copy(l1)		
# 深拷贝
>>> l3 = copy.deepcopy(l1)				
# 浅拷贝、深拷贝和原数组的地址都不一样
>>> print(id(l1),id(l2),id(l3))			
2016648481472 2016648515456 2016648544832	
# 由于原数组的前三个元素是不可变类型，所以不论是深拷贝还是浅拷贝，其与原对象对应元素的地址都是相同的
>>> print(id(l1[0]),id(l2[0]),id(l3[0]))
140710421604128 140710421604128 140710421604128 
>>> print(id(l1[1]),id(l2[1]),id(l3[1]))	   
140710421604160 140710421604160 140710421604160	 
>>> print(id(l1[2]),id(l2[2]),id(l3[2]))
2016610962992 2016610962992 2016610962992
# 原数组的最后一个元素是可变类型(数组list)，所以浅拷贝与原对象对应元素的地址相同，而深拷贝会重新开辟空间。
>>> print(id(l1[3]),id(l2[3]),id(l3[3]))
2016648499776 2016648499776 2016648539584
>>> l1[3][1] = 'c'
>>> l2[3][1]
'c'
>>> l3[3][1]
'b'
```



## 总结：

- 不可变对象在赋值时会开辟新空间；
- 可变对象在赋值时，修改一个的值，另一个也会发生改变；
- 深、浅拷贝对不可变对象拷贝时，不开辟新空间，相当于赋值操作；
- 浅拷贝在拷贝时，只拷贝第一层中的引用，如果元素是可变对象，并且被修改，那么拷贝的对象也会发生变化；
- 深拷贝在拷贝时会逐层进行拷贝，直到所有的引用都是不可变对象为止；
- Python中有多种方式实现浅拷贝，copy模块的copy函数、对象的copy函数、工厂方法、切片等；
- 大多数情况下，编写程序时都是使用浅拷贝，除非有特定的需求；
- 浅拷贝的优点：拷贝速度快，占用空间少，拷贝效率高。